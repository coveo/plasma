name: CI

on:
    pull_request:
        types: [opened, reopened, synchronize]

jobs:
    lint:
        name: Lint Changed Files
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4
              with:
                  fetch-depth: 0
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/lint
              with:
                  WORKFLOW: 'ci'
    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/test
    demo:
        name: Build & Deploy Demo
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            id-token: write
            contents: read
        steps:
            - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/build
            - uses: ./.github/actions/deploy
              id: deploy-demo
              with:
                  AWS_ROLE: ${{ secrets.AWS_ROLE }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
                  AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
            - name: Add demo link as a commment on the PR
              uses: ./.github/actions/comment-on-pr
              with:
                  message: ':heavy_check_mark: [Live demo of your latest successful build available here](https://plasma.coveo.com/feature/${{ steps.deploy-demo.outputs.demo-output-path }}/).'
                  avoidRepostsWith: Live demo of your latest successful build available here
    compatibility:
        name: Validate React 19 Compatibility
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4
            - uses: ./.github/actions/setup
            - name: Build package with React 18
              run: pnpm build --filter=@coveord/plasma-react
            - name: Validate peer dependencies accept React 19
              run: |
                  cd packages/react
                  # Check that all React peer dependencies allow React 19
                  if grep -E '"react":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json && \
                     grep -E '"react-dom":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json && \
                     grep -E '"@types/react":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json && \
                     grep -E '"@types/react-dom":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json; then
                    echo "✅ All React peerDependencies correctly allow React 19"
                  else
                    echo "❌ React peerDependencies do not all allow React 19"
                    echo "Current peerDependencies:"
                    grep -A 6 '"peerDependencies"' package.json
                    exit 1
                  fi
            - name: Upgrade to React 19
              run: |
                  pnpm -r update --filter "@coveord/plasma-react..." react@^19.0.0 react-dom@^19.0.0 @types/react@^19.0.0 @types/react-dom@^19.0.0
            - name: Build with React 19
              run: pnpm build --filter "@coveord/plasma-react..."
            - name: Summary
              if: success()
              run: |
                  echo "✅ React 19 compatibility validation passed!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The @coveord/plasma-react package:" >> $GITHUB_STEP_SUMMARY
                  echo "- Builds successfully with React 18" >> $GITHUB_STEP_SUMMARY
                  echo "- Builds successfully with React 19" >> $GITHUB_STEP_SUMMARY
                  echo "- Has peerDependencies that accept React 19" >> $GITHUB_STEP_SUMMARY
                  echo "- Can be consumed by applications using React 19" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Note:** The package uses React 18 for development and testing, but is compatible with React 19 consumers." >> $GITHUB_STEP_SUMMARY
