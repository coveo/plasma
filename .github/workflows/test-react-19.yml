name: Validate React 19 Compatibility

# This workflow validates that the @coveord/plasma-react package is compatible with React 19.
# The package is built with React 18 (production version), but the peerDependencies allow React 19.
# This ensures consumers can upgrade to React 19 while still using these deprecated packages.

on:
    pull_request:
        types: [opened, reopened, synchronize]
        paths:
            - 'packages/react/**'
            - 'packages/style/**'
            - '.github/workflows/test-react-19.yml'
    workflow_dispatch:

jobs:
    validate-react-19:
        name: Validate React 19 Compatibility
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4

            - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4
              with:
                  registry-url: 'https://registry.npmjs.org'
                  node-version: 20.9.0

            - name: Enable corepack
              run: corepack enable

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build package with React 18
              run: pnpm build --filter=@coveord/plasma-react

            - name: Validate peer dependencies accept React 19
              run: |
                  cd packages/react
                  # Check that all React peer dependencies allow React 19
                  if grep -E '"react":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json && \
                     grep -E '"react-dom":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json && \
                     grep -E '"@types/react":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json && \
                     grep -E '"@types/react-dom":\s*"\^18\.0\s*\|\|\s*\^19\.0"' package.json; then
                    echo "✅ All React peerDependencies correctly allow React 19"
                  else
                    echo "❌ React peerDependencies do not all allow React 19"
                    echo "Current peerDependencies:"
                    grep -A 6 '"peerDependencies"' package.json
                    exit 1
                  fi

            - name: Summary
              if: success()
              run: |
                  echo "✅ React 19 compatibility validation passed!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The @coveord/plasma-react package:" >> $GITHUB_STEP_SUMMARY
                  echo "- Builds successfully with React 18" >> $GITHUB_STEP_SUMMARY
                  echo "- Has peerDependencies that accept React 19" >> $GITHUB_STEP_SUMMARY
                  echo "- Can be consumed by applications using React 19" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Note:** The package uses React 18 for development and testing, but is compatible with React 19 consumers." >> $GITHUB_STEP_SUMMARY
